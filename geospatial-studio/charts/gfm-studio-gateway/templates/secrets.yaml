# Â© Copyright IBM Corporation 2025
# SPDX-License-Identifier: Apache-2.0


apiVersion: v1
kind: Secret
metadata:
  name: auth-seed
type: Opaque
data:
  session_secret: {{ .Values.authseed }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.global.appNames.gateway }}-secrets
type: Opaque
stringData:
  OBJECT_STORAGE_KEY_ID: {{ .Values.global.objectStorage.access_key }}
  OBJECT_STORAGE_SEC_KEY: {{ .Values.global.objectStorage.secret_key }}
  SH_CLIENT_ID: {{ .Values.global.sentinelhub.client_id }}
  SH_CLIENT_SECRET: {{ .Values.global.sentinelhub.client_secret }}
  {{- if .Values.global.postgresql.in_cluster_db }}
  DATABASE_URI: "postgresql+pg8000://{{ .Values.global.postgresql.auth.username}}:{{ .Values.global.postgresql.auth.password }}@{{ .Release.Name }}-postgresql-hl.{{ .Release.Namespace }}.svc/{{ .Values.global.postgresql.dbs.gateway }}"
  AUTH_DATABASE_URI: "postgresql+pg8000://{{ .Values.global.postgresql.auth.username}}:{{ .Values.global.postgresql.auth.password }}@{{ .Release.Name }}-postgresql-hl.{{ .Release.Namespace }}.svc/{{ .Values.global.postgresql.dbs.auth }}"
  MLFLOW_DATABASE_URI: "postgresql+pg8000://{{ .Values.global.postgresql.auth.username}}:{{ .Values.global.postgresql.auth.password }}@{{ .Release.Name }}-postgresql-hl.{{ .Release.Namespace }}.svc/{{ .Values.global.postgresql.dbs.mlflow }}"
  {{- else }}
  DATABASE_URI: {{ .Values.global.postgres.backend_uri_base }}/{{ .Values.global.postgres.dbs.gateway }}
  AUTH_DATABASE_URI: {{ .Values.global.postgres.backend_uri_base }}/{{ .Values.global.postgres.dbs.auth }}
  MLFLOW_DATABASE_URI: {{ .Values.global.postgres.backend_uri_base }}/{{ .Values.global.postgres.dbs.mlflow }}
  {{- end }}
  {{- if .Values.global.redis.enabled }}
  {{- if eq .Values.global.redis.architecture "standalone" }}
  REDIS_URL: {{ (printf "redis://:%s@%s-redis-headless.%s.svc" .Values.global.redis.password .Release.Name .Release.Namespace) | quote }}
  {{- else }}
  REDIS_URL: {{ (printf "redis://:%s@%s-master.%s.svc" .Values.global.redis.password .Values.global.redis.fullnameOverride .Release.Namespace) | quote }}
  {{- end }}
  {{- end }}
  {{- /* Extra environment variables to be passed fro the Values.extraEnvironment */ -}}
  {{- range $name, $value := .Values.extraEnvironment.secrets }}
  {{ $name }}: {{ quote $value }}
  {{- end }}
  FT_API_KEY: {{ .Values.global.gfmStudioGateway.api_key }}
  API_ENCRYPTION_KEY: {{ .Values.global.gfmStudioGateway.api_encryption_key }}
  JIRA_API_KEY: {{ .Values.global.jira.api_key }}

---
apiVersion: v1
kind: Secret
metadata:
  namespace: {{ .Values.global.namespace }}
  name: geoft-cronjob-secrets
type: Opaque
stringData:
  FT_API_KEY: {{ .Values.global.gfmStudioGateway.api_key }}
  FT_WEBHOOKS_ID: {{ .Values.webhook_event_id }}
  GEOFT_WEBHOOK_URL: {{ printf "https://%s-%s.%s/v2/notifications" .Values.global.appNames.gateway .Values.global.namespace .Values.global.cluster_url }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.global.appNames.gateway }}-cos-secret
type: ibm/ibmc-s3fs
data:
  access-key: {{ .Values.global.objectStorage.access_key | b64enc | quote }}
  secret-key: {{ .Values.global.objectStorage.secret_key | b64enc | quote }}

---
{{- $globalSecretType := .Values.global.secretType -}}
{{- range $name, $details := .Values.secret }}
{{- if $details.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $details.secretName }}
  annotations:
    {{ default "{}" $details.annotations }}
stringData:
  {{- /* Secret in raw string data format. Not base64 */ -}}
  {{- range $key, $value := $details.secretStringData }}
  {{ $key }}: {{ quote $value }}
  {{- end }}
type: {{ $details.customSecretType | default $globalSecretType }}
--- 
{{- end -}}
{{- end }}
---
{{- /* tls secret for kubernetes environment */ -}}
{{- if and (.Values.global.oauth.oauthProxyEnabled)  (.Values.global.oauth.createTLSSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.global.appNames.gateway }}-authentication-tls
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.global.oauth.tlsCrtB64 }}
  tls.key: {{ .Values.global.oauth.tlsKeyB64 }}
{{- end }}
