# Â© Copyright IBM Corporation 2025
# SPDX-License-Identifier: Apache-2.0


kind: Deployment
apiVersion: apps/v1
metadata:
  name: {{ .Values.global.appNames.gateway }}
  labels:
    app: {{ .Values.global.appNames.gateway }}
    cashDeploymentId: {{ .Values.global.appNames.gateway }}
spec:
  replicas:  {{ .Values.replicaCount }}
  strategy:
    type: {{ .Values.strategy }}
    {{- if .Values.rollingUpdate.enabled }}
    rollingUpdate:
      maxSurge: {{ .Values.rollingUpdate.maxSurge }}
      maxUnavailable: {{ .Values.rollingUpdate.maxUnavailable }}
    {{- end }}
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: {{ .Values.global.appNames.gateway }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
      labels:
        app: {{ .Values.global.appNames.gateway }}
    spec:
      securityContext:
        {{- toYaml .Values.securityContext.api | nindent 10 }}
      {{- if .Values.global.imagePullSecret }}
      imagePullSecrets:
        - name: {{ .Values.global.imagePullSecret.name }}
      {{- end }}
      initContainers:
        - name: db-migration
          image: {{ .Values.image.name }}:{{ .Values.image.tag }}
          imagePullPolicy: Always
          command:
            - "sh"
            - "-c"
            - "alembic upgrade head && alembic -n auth upgrade head"
          envFrom:
            - configMapRef:
                name: {{ .Values.global.appNames.gateway }}-cm
            - secretRef:
                name: {{ .Values.global.appNames.gateway }}-secrets
      containers:
        - name: gateway-api
          resources:
            {{- toYaml .Values.resources.api | nindent 12 }}
          image: {{ .Values.image.name }}:{{ .Values.image.tag }}
          ports:
            - containerPort: 8000
              protocol: TCP
          command:
            {{- toYaml .Values.command.api | nindent 12 }}
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: {{ .Values.global.appNames.gateway }}-cm
            - secretRef:
                name: {{ .Values.global.appNames.gateway }}-secrets
          volumeMounts:
            {{- if .Values.global.oauth.oauthProxyEnabled }}
            - name: secret-tls
              mountPath: /etc/tls/private
            {{- end }}
            - name: mount-files
              mountPath: {{ .Values.mountLocations.files_mount }}
            - name: data-pipeline-jobs
              mountPath: /app/deployment/jobs
            - name: data-pipeline-logs
              mountPath: /app/deployment/logs
            {{- if .Values.global.sharePipelinePvc }}
            - name: pipelines-inference-pvc
              mountPath: /data
            {{- end }}
            # Dynamic mounts from values
            {{- range $name, $details := .Values.persistence }}
            {{- if $details.mountPathGateway -}} {{/* Should we mount it here? */}}
            - mountPath: {{ $details.mountPathGateway }}
              name: {{ $name }}
            {{- else }}
            # Skipping {{ $name }} from gateway deployment
            {{- end }}
            {{- end }}
        {{- if .Values.global.oauth.oauthProxyEnabled }}
        - name: oauth-proxy
          {{- include "oauth.args" . | trim | nindent 10 }}
            - --upstream=http://localhost:8000
            # NOTE: Skipping Auth because authentication is handled in the app to support both api-key and bearer-token auth.
            - --skip-auth-route=^(/v[1|2]+/.*)|(/openapi\.json)$
          image: {{ .Values.global.oauth.image.name }}:{{ .Values.global.oauth.image.tag }}
          imagePullPolicy: Always
          ports:
            - name: oauth-proxy
              containerPort: {{ .Values.global.oauth.oauthProxyPort }}
              protocol: TCP
          volumeMounts:
            - name: secret-tls
              mountPath: /etc/tls/private
            - name: trusted-certificates-ca
              mountPath: /etc/tls/openshift-certificate/
          resources:
            {{- toYaml .Values.resources.oauth | nindent 12 }}
        {{- end }}
        - name: {{ .Values.global.appNames.gateway }}-mlflow-notify
          resources:
            {{- toYaml .Values.resources.mlflowNotify | nindent 12 }}
          image: {{ .Values.image.name }}:{{ .Values.image.tag }}
          imagePullPolicy: Always
          command: ["python", "gfmstudio/fine_tuning/subscribe_new_mlflow_run.py"]
          envFrom:
            - secretRef:
                name: {{ .Values.global.appNames.gateway }}-secrets
      serviceAccountName: {{ .Values.serviceAccount.name }}
      volumes:
        {{- if .Values.global.oauth.oauthProxyEnabled }}
        - name: secret-tls
          secret:
            secretName: {{ .Values.global.appNames.gateway }}-authentication-tls
        - name: trusted-certificates-ca
          configMap:
            name: {{ .Values.global.appNames.gateway }}-trusted-certificates-ca
        {{- end }}
        - name: mount-files
          {{- if .Values.global.storage.pvc.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Values.mountLocations.files_pvc_name }}
          {{- else }}
          # mount directory from the host node's filesystem into the Pod.
          hostPath:
            path: {{ .Values.global.storage.filesystem.dir }}{{ .Values.mountLocations.files_pvc_name }}
            type: DirectoryOrCreate
          {{- end }}
        {{- if .Values.global.sharePipelinePvc }}
        - name: pipelines-inference-pvc
          persistentVolumeClaim:
            claimName: inference-shared-pvc
        {{- end }}
        - name: data-pipeline-jobs
          emptyDir: {}
        - name: data-pipeline-logs
          emptyDir: {}
        {{- range $name, $details := .Values.persistence }}
        {{- if $details.mountPathGateway }}
        - name: {{ $name }}
          persistentVolumeClaim:
            claimName: {{ $details.claimName }}
        {{ else }}
        # Skipping volume {{ $name }} because it's not mounted by mountPathGateway
        {{- end -}}
        {{- end }}
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      {{ if .Values.tolerations.enabled }}
      tolerations:
        {{- toYaml .Values.tolerations.configs | nindent 10 }}
      {{ end }}
