# Â© Copyright IBM Corporation 2025
# SPDX-License-Identifier: Apache-2.0


{{- $release := .Release -}}
{{- $chart := .Chart -}}
{{- $values := .Values -}}
{{- range $hook_name, $config := $values.hooks }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ $values.global.appNames.gateway | default $release.Name }}-{{ $hook_name }}"
  labels:
    app.kubernetes.io/managed-by: {{ $release.Service | quote }}
    app.kubernetes.io/instance: {{ $values.global.appNames.gateway | default $release.Name | quote }}
    app.kubernetes.io/version: {{ $chart.AppVersion }}
    helm.sh/chart: "{{ $chart.Name }}-{{ $chart.Version }}"
  annotations:
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    "helm.sh/hook": {{ join "," $config.when | quote }}
    "helm.sh/hook-weight": {{ $config.weight | quote }}
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      name: "{{ $values.global.appNames.gateway | default $release.Name }}"
      labels:
        app.kubernetes.io/managed-by: {{ $release.Service | quote }}
        app.kubernetes.io/instance: {{ $values.global.appNames.gateway | default $release.Name | quote }}
        helm.sh/chart: "{{ $chart.Name }}-{{ $chart.Version }}"
    spec:
      restartPolicy: Never
      {{- if $values.global.imagePullSecret }}
      imagePullSecrets:
        - name: {{ $values.global.imagePullSecret.name }}
      {{- end }}
      {{- if or (and (hasKey $config "waitForPods") $config.waitForPods.enabled) (and (hasKey $config "waitForDb") $config.waitForDb.enabled) }}
      initContainers:
      {{- end }}
      # Init container to wait for database to be ready (for pre-install hooks)
      {{- if hasKey $config "waitForDb" }}
      {{- if $config.waitForDb.enabled }}
      - name: wait-for-db
        image: {{ $config.waitForDb.image | default "postgres:13" }}
        imagePullPolicy: {{ $values.image.pullPolicy }}
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for database to be ready..."
          DB_URI=$(echo "$AUTH_DATABASE_URI" | sed 's/+pg8000//')
          until pg_isready -d "$DB_URI" -t 3; do
            echo "Database not ready yet, retrying in {{ $config.waitForDb.sleepTime | default 5 }} seconds..."
            sleep {{ $config.waitForDb.sleepTime | default 5 }}
          done
          echo "Database is ready!"
        envFrom:
          - configMapRef:
              name: {{ $values.global.appNames.gateway }}-cm
          - secretRef:
              name: {{ $values.global.appNames.gateway }}-secrets
      {{- end }}
      {{- end }}
      # Init container to wait for required pods to be ready (for post-install hooks)
      {{- if hasKey $config "waitForPods" }}
      {{- if $config.waitForPods.enabled }}
      - name: wait-for-pods
        image: {{ $config.waitForPods.image | default "bitnami/kubectl:latest" }}
        imagePullPolicy: {{ $values.image.pullPolicy }}
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for required pods to be ready..."
          {{- range $config.waitForPods.pods }}
          echo "Checking {{ .selector }} in namespace {{ $.Values.global.namespace }}..."
          until kubectl get pods -n {{ $.Values.global.namespace }} -l {{ .selector }} --field-selector=status.phase=Running 2>/dev/null | grep -q Running; do
            echo "Pod {{ .selector }} not running yet, retrying in {{ $config.waitForPods.sleepTime | default 5 }} seconds..."
            sleep {{ $config.waitForPods.sleepTime | default 5 }}
          done
          echo "Pod {{ .selector }} is running!"
          {{- end }}
          echo "All required pods are ready!"
      {{- end }}
      {{- end }}
      containers:
      - name: {{ $hook_name }}-job
        {{- if hasKey $config "image" }}
        image: "{{ $config.image }}"
        {{- else }}
        image: "{{ $values.image.name }}:{{ $values.image.tag }}"
        {{- end }}
        imagePullPolicy: {{ $values.image.pullPolicy }}
        command:
        {{- range $config.command }}
            - {{ . | quote }}
        {{- end }}
        envFrom:
          - configMapRef:
              name: {{ $values.global.appNames.gateway }}-cm
          - secretRef:
              name: {{ $values.global.appNames.gateway }}-secrets
        {{- if hasKey $config "volumeMounts" }}
        volumeMounts:
        {{- range $config.volumeMounts }}
        - name: {{ .name }}
          mountPath: {{ .mountPath }}
          {{- if hasKey . "subPath" }}
          subPath: {{ .subPath }}
          {{- end }}
        {{- end }}
        {{- end }}
      {{- if hasKey $config "volumes" }}
      volumes:
      {{- range $config.volumes }}
      - name: {{ .name }}
        configMap:
          name: {{ tpl .configMapName $ }}
      {{- end }}
      {{- end }}
---
{{- end }}
